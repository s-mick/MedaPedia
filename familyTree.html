<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Arbre généalogique</title>
  <meta name="description" content="Arbre généalogique des razhi de Medainë" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style type="text/css">
    #miniViewDiv {
      position: absolute;
      width: 200px;
      height: 150px;
      top: 10px;
      left: 10px;
      background-color: beige;
      z-index: 100; /* Make sure it is in front */
      border: solid 1px black;
    }
    .zoomSlider {
      position: absolute;
      top: 10px !important;
      left: 220px !important;
      z-index: 100;
    }
  </style>
  <script src="https://unpkg.com/gojs/release/go.js"></script>
  <script src="https://unpkg.com/gojs/extensions/HyperlinkText.js"></script>
  <script src="https://unpkg.com/gojs/extensions/ZoomSlider.js"></script>
  <script id="code">
    // Convenient shortcut for the rest of the script
    var $ = go.GraphObject.make;
    // Base URL for hyperlinks to wiki pages
    var baseURL = "../doku.php?id=";

    function formatInfoText(info) {
      var str = "";
      if (info.title) str += "Title: " + info.title;
      if (info.headOf) str += "\n\nHead of: " + info.headOf;
      if (typeof info.boss === "number") {
        var bossinfo = treeDiagram.model.findNodeDataForKey(info.boss);
        if (bossinfo !== null) {
          str += "\n\nReporting to: " + bossinfo.name;
        }
      }
      return str;
    }

    function swapBoxColor(box, defColor, newColor) {
      for (var key in box) {
        if (box.hasOwnProperty(key)) {
          for (var subkey in box.key) {
            if (box.key.hasOwnProperty(subkey)) {
              if (box.key == defColor) {
                box.key = newColor;
                return "Done." } } } } }
    }

    function makeDiagram(nodeData) {
      treeDiagram =
        $(go.Diagram, "treeDiv",
          {
            // Put diagram contents at the top center of viewport
            initialDocumentSpot: go.Spot.TopCenter,
            initialViewportSpot: go.Spot.TopCenter,
            layout:
              $(go.TreeLayout,  // use a TreeLayout to position all nodes
                {
                  treeStyle: go.TreeLayout.StyleLastParents,
                  // Properties for most of the tree:
                  angle: 90,
                  layerSpacing: 80,
                  // Properties for the "last parents":
                  alternateAngle: 0,
                  alternateAlignment: go.TreeLayout.AlignmentStart,
                  alternateNodeIndent: 20,
                  alternateNodeIndentPastParent: 1,
                  alternateNodeSpacing: 20,
                  alternateLayerSpacing: 40,
                  alternateLayerSpacingParentOverlap: 1,
                  alternatePortSpot: new go.Spot(0.001, 1, 20, 0),
                  alternateChildPortSpot: go.Spot.TopLeft
                })
          });

      treeDiagram.nodeTemplate =
        $(go.Node, "Auto",
          // Outer shape for Node, surrounding the Table
          $(go.Shape, "Rectangle",
            { stroke: null, strokeWidth: 0, fill: "#f2f2b6" }),
          // Table to contain different parts of the Node
          $(go.Panel, "Table",
            { margin: 6, maxSize: new go.Size(200, NaN) },
            // TextBlocks in column 0 both stretch in width but align on left side
            $(go.RowColumnDefinition,
              {
                column: 0,
                stretch: go.GraphObject.Horizontal,
                alignment: go.Spot.Left
              }),
            // Name
            $(go.TextBlock,
              {
                row: 0, column: 0,
                maxSize: new go.Size(160, NaN), margin: 2,
                font: "500 16px Arial, sans-serif",
                alignment: go.Spot.Top
              },
              new go.Binding("text", "name")),
            // Additional info
            $(go.TextBlock,
              {
                row: 1, column: 0, columnSpan: 2,
                font: "12px Arial, sans-serif"
              },
              new go.Binding("text", "", formatInfoText)),
            // Hyperlink
            $("HyperlinkText",
              function(node) { return baseURL + node.data.key.toString();},
              function(node) { return node.data.name},
              { row: 2, column: 0}),
          )
        );

      // Define Link template as a simple orthogonal line
      treeDiagram.linkTemplate =
        $(go.Link, go.Link.Orthogonal,
          { corner: 5, selectable: false },
          $(go.Shape, { strokeWidth: 3, stroke: "#424242" }));  // Dark gray, rounded corner links

      // Create Model with data for the tree, and assign to Diagram
      treeDiagram.model =
        $(go.TreeModel,
          {
            nodeParentKeyProperty: "boss",  // This property refers to the parent node data
            nodeDataArray: nodeData.nodes
          });

      // Mini overview of the full diagram
      miniView =
        $(go.Overview, "miniViewDiv",
          // Indicate which Diagram to show and pan
          { observed: treeDiagram, contentAlignment: go.Spot.Center });
      // Change default color of the rectangle box
      swapBoxColor(miniview.box, "magenta", "gray")

      // Zoom slider
      zoomSlider = new ZoomSlider(treeDiagram,
        { alignment: go.Spot.TopLeft, alignmentFocus: go.Spot.TopLeft,
          size: 150, buttonSize: 25, orientation: 'vertical' });
    }

    // Access then load source JSON file online
    function loadJSON(callback, src) {
        var xhr = new XMLHttpRequest();
        xhr.overrideMimeType("application/json");
        xhr.open('GET', src, true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == "200") {
              console.log("Remote JSON loaded.")
              callback(JSON.parse(xhr.responseText));
            }
        };
        xhr.send(null);
    };

    function init() {
      loadJSON(makeDiagram, srcpath)
    }

    var srcpath = 'https://raw.githubusercontent.com/s-mick/MedaPedia/master/dynasty.json';

</script>
</head>
<body onload="init()">
<div id="treeDiagram" style="position: relative;">
  <div id="treeDiv"
    style="background-color: white; border: solid 1px black; width: 100%; height: 850px">
  </div>
  <div id="miniViewDiv"></div>
</div>
</body>
</html>
